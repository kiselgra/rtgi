#!/bin/bash

if [ $# -eq 0 -o $# -gt 2 ] ; then
	echo "Need arguments: the assignment number [ref]"
	exit 1
fi

ASS="$1"
REF="$2"

branch="master"
if [ "$(git branch --show-current)" != "$branch" ] ; then
	echo -e "\e[31mWarning: generating assignment from $(git branch --show-current), not $branch!\e[0m"
fi

# TODO use $branch
git archive --prefix make-ass/ -o make-ass.tar $(git branch --show-current)
if [ -e make-ass ] ; then
	echo make-ass already exists!
	exit 1
fi
tar xf make-ass.tar
cd make-ass

ASS=$(printf "%02d" "$ASS")
if [ "$REF" != "" ] ; then
	REF="-$REF"
fi
sed -i 's/\[2021\]/[2021-a'$ASS$REF']/' configure.ac

for f in $(find . -name "*.cpp" -o -name "*.h" -o -name "Makefile.am") configure.ac ; do
	unifdef -x2 -m -f assconf/a$ASS$REF "$f"
done

#cd ..; cp -r make-ass /tmp/; cd -;
autoreconf -if && ./configure && make -j20
make dist-bzip2
cp rtgi-2021-a??$REF.tar.bz2 ..
cd ..
rm -r make-ass
